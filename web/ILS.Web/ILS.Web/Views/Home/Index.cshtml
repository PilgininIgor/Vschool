@{
    ViewBag.Title = "3Ducation | Виртуальный мир";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}
@section additionalCSS {
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/user.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/about.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/profile.css")" />
    <link rel="stylesheet" href="@Url.Content("~/UnityDeploy/TemplateData/style.css")">
    <link rel="shortcut icon" href="@Url.Content("~/UnityDeploy/TemplateData/favicon.ico")" />
}
@section scripts{
    <script src="@Url.Content("~/UnityDeploy/TemplateData/UnityProgress.js")"></script>
    <script type="text/javascript" src="Scripts/jwp/jwplayer.js"></script>
    <script type="text/javascript" src="Scripts/ils.about.js"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/render.js")"></script>
    <script type="text/javascript">
        function dhtmlLoadScript(url) {
           var e = document.createElement("script");
           e.src = url;
           e.type="text/javascript";
           document.getElementsByTagName("head")[0].appendChild(e);
        }
    </script>
    <script type='text/javascript'>
            var Module = {
                TOTAL_MEMORY: 268435456,
                errorhandler: null,
                compatibilitycheck: null,
                backgroundColor: "#222C36",
                splashStyle: "Light",
                dataUrl: "@Url.Content("~/UnityDeploy/Release/WebGL.data")",
                codeUrl: "@Url.Content("~/UnityDeploy/Release/WebGL.js")",
                asmUrl: "@Url.Content("~/UnityDeploy/Release/WebGL.asm.js")",
                memUrl: "@Url.Content("~/UnityDeploy/Release/WebGL.mem")",
            };
    </script>
    <script type="text/javascript">
        getUnityImage = '@Url.Content("~/Content/pics_service/UnitySetup.png")';
        link_unityRPG = '@Url.Action("UnityRPG", "Render")';
        link_unitylist = '@Url.Action("UnityList", "Render")';
        link_unitydata = '@Url.Action("UnityData", "Render")';
        link_unitystat = '@Url.Action("UnityStat", "Render")';
        link_unitysave = '@Url.Action("UnitySave", "Render")';
        link_unitysaveRPG = '@Url.Action("UnitySaveRPG", "Render")';
        link_unitytest = '@Url.Action("UnityTest", "Render")';

        var virtual_world = new Ext.panel.Panel({
        });
        var embedded = false;
        var width; var height;

        function startUnityPlayer() {
            if (!embedded) {
                embedded = true;
                var params = { disableContextMenu: true };

                document.getElementById("unityPlayer").innerHTML =
                    '<div class="template" style="width: 809px; height: 400px; position: static">' +
                    '<div class="template-wrap clear" title="" style="width: 809px; height: 400px;">' +
                    '<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" width="809" height="320"></canvas>' +
                    '<br>' +
                    '<div class="logo"></div>' +
                        '<div class="fullscreen">' +
                            '<img src="@Url.Content("~/UnityDeploy/TemplateData/fullscreen.png")" alt="Fullscreen" title="Fullscreen" onclick="SetFullscreen(1);" width="38" height="38">' +
                    '</div>' +
                    '<div class="title">Main</div>' +
                    '</div>' +
                '</div>';
                dhtmlLoadScript("/UnityDeploy/Release/UnityLoader.js");

                if (document.getElementById("unityPlayer").childNodes[0].tagName == "DIV") {
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('updater').style.display = 'none';
                }

            }
        }


    </script>
    <script type="text/javascript">
        var img;
        var canvas;
        var frame = 0;
        var ITHASBEGUN = false;
		var currentUser;
		var selectedUser;

        var reinitialized = false;

        window.onload = function () {

            jwplayer("videoPlayer").setup({
                flashplayer: "@Url.Content("~/Scripts/jwp/player.swf")",
                file: "Content/demo.flv",
                height: 400,
                width: 809
            });

            var index = frame + 1;
            image = document.getElementById("enter" + index);
            img = new Image();
            img.src = image.src;
            canvas = document.getElementById("rotate");
            canvas.width = image.width;
            canvas.height = image.height;
            img.context = canvas.getContext("2d");
            img.canvas = canvas;
            img.radians = Math.PI / 180;
            canvas_rotate.call(img, 0);

            var frameVisors = 0;
            var timerVisors;
            var framesVisors = document.getElementById("visorsContainer").children;
            function visors() {
                framesVisors[frameVisors].style.display = "none";
                frameVisors++;
                if (frameVisors == 15) {
                    frameVisors = 0;
                }
                framesVisors[frameVisors].style.display = "block";
            }
            timerVisors = setInterval(visors, 40);

            var index = document.location.href.indexOf("?action=");
            if (index != -1) {
                var action = document.location.href.slice(index + 8);
                if (action == "video")
                    demo_video();
                else if (action == "game")
                    demo_game();
            }

            var frameDots = 0;
            var timerDots;
            var framesDots = document.getElementById("dotsContainer").children;
            function Dots() {
                framesDots[frameDots].style.display = "none";
                frameDots++;
                if (frameDots == 15) {
                    frameDots = 0;
                }
                framesDots[frameDots].style.display = "block";
            }
            timerDots = setInterval(Dots, 120);

			resume();

        }

        function canvas_rotate(rotate) {
            img.context.clearRect(0, 0, img.width, img.height);
            this.context.save();
            this.context.translate(this.width / 2, this.height / 2);
            this.context.rotate(rotate * this.radians);
            this.context.drawImage(this, -(this.width / 2), -(this.height / 2));
            this.context.restore();
        }

        var animationInProgress = false;

        var authorisationComplete = false;
        var authorisationSucceed = false;
        var authorisationNotStarted = true;
        var contentType = 0; //0 - authorise & play, 1 - demo play, 2 - demo video
        var timer;

        window.addEventListener("message", receiveMessage, false);

        function receiveMessage(event) {
            var message = JSON.parse(event.data);
            if (message.header == 'authorise')
                this.authorise(message.login, message.success, message.firstName, message.admin);
        }

        authorise = function (login, success, firstName, admin) {
            authorisationComplete = true;
            if (success) {
                authorisationSucceed = true;
				currentUser = login;
                document.getElementById('helloPanel').style.display = "block";
                document.getElementById('helloInactive').style.display = "none";
                document.getElementById('credentials').innerHTML = firstName;
                document.getElementById('adminLink').style.display = admin ? "block" : "none";
                document.getElementById('profileLink').style.display = admin ? "none" : "block";
            } else {
                authorisationSucceed = false;
                document.getElementById('helloPanel').style.display = "none";
                document.getElementById('helloInactive').style.display = "block";
            }
        }

        function enter_click(animate) {
            animationInProgress = true;
            var needSlice = (document.location.href.indexOf("http://") != -1);
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1);
            url = "http://workstation.itschool.ssau.ru/account/logon/?extUrl=" + (needSlice ? url.slice(7) : url) + "openid";
            ITHASBEGUN = true;
            var left = 0;
            var angle = 0;
            var eleft = -176;
            var authorisationWindow;
            clearInterval(enterTimer);
            function waitForAuthorisation() {
                if (authorisationWindow == null || authorisationWindow.closed) {
                    clearInterval(timer);
                    document.getElementById('awaitingAuthorisation').style.display = 'none';
                    document.getElementById('awaitingLoading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                }
                document.getElementById('mainDoors').style.display = 'none';
                if (authorisationComplete) {
                    clearInterval(timer);
                    if (authorisationSucceed) {
                        document.getElementById('awaitingAuthorisation').style.display = 'none';
                        document.getElementById('awaitingLoading').style.display = 'block';
                        document.getElementById('error').style.display = 'none';
                        document.getElementById("videoPlayer").style.display = 'none';
                        startUnityPlayer();
                    } else {
                        document.getElementById('awaitingAuthorisation').style.display = 'none';
                        document.getElementById('awaitingLoading').style.display = 'none';
                        document.getElementById('error').style.display = 'block';
                    }
                }
            }
            function move() {
                if (reinitialized) {
                    clearInterval(timer);
                    reinitialized = false;
                    return;
                }
                if (angle <= 90 && animate) {
                    canvas_rotate.call(img, angle);
                    angle += 10;
                }
                else {
                    if (left > -700 && animate) {
                        left -= 30;
                        eleft -= 30;
                        document.getElementById('doorl').style.left = left + 'px';
                        document.getElementById('doorr').style.left = 406 - left + 'px';
                        document.getElementById('container').style.marginLeft = eleft + 'px';
                    } else {
                        if (contentType == 0) {
                            var offsetLeft = window.screenX + (window.outerWidth - window.innerWidth) / 2;
                            var offsetTop = window.screenY + (window.outerHeight - window.innerHeight) - 5;
                            var obj = document.getElementById('mainDoors');
                            do {
                                offsetLeft += obj.offsetLeft;
                                offsetTop += obj.offsetTop;
                            } while (obj = obj.offsetParent)
                            var awLeft = offsetLeft;
                            var awTop = offsetTop;
                            clearInterval(timer);
                            //var authorisationWindow = window.open(url, '_blank', 'height=399, width=809, top=' + awTop + ', left=' + awLeft + ', scrollable=no, menubar=no, resizable=no, location=no');
                            if (authorisationWindow == null) {
                                authorisationWindow = window.open(url, '_blank', 'fullscreen=yes, scrollable=no, menubar=no, resizable=no, location=no');
                                authorisationWindow.focus();
                                authorisationWindow.onload = new function () {
                                    var awWidth = authorisationWindow.window.outerWidth;
                                    var awHeight = authorisationWindow.window.outerHeight;
                                    var awInnerWidth = authorisationWindow.window.innerWidth;
                                    var awInnerHeight = authorisationWindow.window.innerHeight;
                                    //alert(awWidth + " " + awHeight);
                                    awWidth = awInnerWidth - awWidth;
                                    awHeight = awInnerHeight - awHeight;
                                    //alert(awWidth + " " + awHeight);
                                    //authorisationWindow.window.resizeBy(awWidth, awHeight);
                                }
                            }
                            animationInProgress = false;
                            timer = setInterval(waitForAuthorisation, 50);
                        } else if (contentType == 1) {
                            clearInterval(timer);
                            animationInProgress = false;
                            document.getElementById('awaitingAuthorisation').style.display = 'none';
                            document.getElementById('awaitingLoading').style.display = 'block';
                            document.getElementById('error').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("videoPlayer").style.display = 'none';
                            startUnityPlayer();
                        } else if (contentType == 2) {
                            clearInterval(timer);
                            animationInProgress = false;
                            document.getElementById('loadingContainer').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("unityPlayer").style.display = 'none';
                            document.getElementById("videoPlayer").style.display = 'block';
                        } else if (contentType == 3) {
                            clearInterval(timer);
                            animationInProgress = false;
                            document.getElementById('aboutContainer').style.display = 'block';
                            document.getElementById('loadingContainer').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("unityPlayer").style.display = 'none';
                            document.getElementById("videoPlayer").style.display = 'none';
                            document.getElementById('dotsContainer').style.display = 'block';
                        } else if (contentType == 4) {
                            clearInterval(timer);
                            animationInProgress = false;
                            document.getElementById('contactsContainer').style.display = 'block';
                            document.getElementById('loadingContainer').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("unityPlayer").style.display = 'none';
                            document.getElementById("videoPlayer").style.display = 'none';
                            document.getElementById('dotsContainer').style.display = 'block';
                        }
                    }
                }
            }
            timer = setInterval(move, 50)
        }

        function close_doors(reopen) {
            animationInProgress = true;
            var left = -720;
            var angle = 90;
            var eleft = -896;
            canvas_rotate.call(img, angle);
            function move() {
                if (left < 0) {
                    left += 30;
                    eleft += 30;
                    document.getElementById('doorl').style.left = left + 'px';
                    document.getElementById('doorr').style.left = 406 - left + 'px';
                    document.getElementById('container').style.marginLeft = eleft + 'px';
                } else {
                    if (angle >= 0) {
                        canvas_rotate.call(img, angle);
                        angle -= 10;
                    } else {
                        clearInterval(timer);
                        if (reopen)
                            enter_click(true);
                        else
                            animationInProgress = false;
                    }
                }
            }
            timer = setInterval(move, 50)
        }

        function openAuthWindow() {
            document.getElementById('awaitingAuthorisation').style.display = 'block';
            document.getElementById('awaitingLoading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            authorisationComplete = false;
            authorisationNotStarted = true;
            authorisationSucceed = false;
            contentType = 0;
            enter_click(false);
        }


        var enterTimer;

        function enter_animate() {
            if (ITHASBEGUN) {
                return;
            }
            clearInterval(enterTimer);
            var frames = document.getElementById("container").children;
            function move() {
                if (animationInProgress || ITHASBEGUN) {
                    return;
                }
                frame++;
                if (frame == 13) {
                    frame = 7;
                }
                img.src = frames[frame].src;
                canvas_rotate.call(img, 0);
            }
            enterTimer = setInterval(move, 70);
        }

        function enter_stop() {
            if (ITHASBEGUN) {
                return;
            }
            clearInterval(enterTimer);
            var frames = document.getElementById("container").children;
            function move() {
                if (animationInProgress || ITHASBEGUN) {
                    return;
                }
                if (frame < 1) {
                    clearInterval(enterTimer);
                    frame = 1;
                }
                frame--;
                img.src = frames[frame].src;
                canvas_rotate.call(img, 0);

            }
            enterTimer = setInterval(move, 70);
        }

        function main_page() {
            if (animationInProgress)
                return;
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_a.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_ia.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_ia.png";
            reinit();
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(false);
            }
        }

        function enter_main() {
            if (animationInProgress)
                return;
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_a.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_ia.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_ia.png";
            reinit();
            contentType = 0;
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(true);
                return;
            } else {
                ITHASBEGUN = false;
                enter_click(true);
            }
        }



        function demo_video() {
            if (animationInProgress)
                return;
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_a.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_ia.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_ia.png";
            reinit();
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 2;
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(true);
                return;
            } else {
                ITHASBEGUN = false;
                enter_click(true);
            }
        }

        function demo_game() {
            if (animationInProgress)
                return;
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_a.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_ia.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_ia.png";
            reinit();
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 1;
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(true);
                return;
            } else {
                ITHASBEGUN = false;
                enter_click(true);
            }
        }

        function contacts() {
            if (animationInProgress)
                return;
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_ia.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_ia.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_a.png";
            reinit();
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 4;
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(true);
                return;
            } else {
                ITHASBEGUN = false;
                enter_click(true);
            }
        }

        function about() {
            if (animationInProgress)
                return;
            sliderAuthorsInit();
            initContents();
            document.getElementById("buttonMain").src = "/Content/Sprites/button_main_ia.png";
            document.getElementById("buttonAbout").src = "/Content/Sprites/button_about_a.png";
            document.getElementById("buttonContacts").src = "/Content/Sprites/button_contact_ia.png";
            reinit();
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 3;
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(true);
                return;
            } else {
                ITHASBEGUN = false;
                enter_click(true);
            }
        }

        function reinit() {

            clearInterval(timer);
            reinitialized = true;

            embedded = false;

            index = 1;

            image = document.getElementById("enter" + index);
            img = new Image();
            img.src = image.src;
            canvas = document.getElementById("rotate");
            canvas.width = image.width;
            canvas.height = image.height;
            img.context = canvas.getContext("2d");
            img.canvas = canvas;
            img.radians = Math.PI / 180;
            canvas_rotate.call(img, 0);

            authorisationComplete = false;
            authorisationSucceed = false;
            authorisationNotStarted = true;
            contentType = 0;
            timer = null;

            //document.getElementById('doorl').style.left = 0 + 'px';
            //document.getElementById('doorr').style.left = 406 + 'px';
            //document.getElementById('container').style.marginLeft = -176 + 'px';
            authorisationWindow = null;
            enterTimer = null;

            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('awaitingAuthorisation').style.display = 'block';
            document.getElementById('awaitingLoading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('mainDoors').style.display = 'block';
            document.getElementById('contactsContainer').style.display = 'none';
            document.getElementById('aboutContainer').style.display = 'none';
            document.getElementById('dotsContainer').style.display = 'none';
            document.getElementById('updater').style.display = 'block';

            if (document.getElementById('videoPlayer_wrapper') != null) {
                document.getElementById('videoPlayer_wrapper').innerHTML = '';
                document.getElementById('videoPlayer_wrapper').id = 'videoPlayer';
                jwplayer("videoPlayer").setup({
                    flashplayer: "@Url.Content("~/Scripts/jwp/player.swf")",
                    file: "Content/demo.flv",
                    height: 400,
                    width: 809
                });

            }
            //document.getElementById('unityPlayer').innerHTML = '';
            document.getElementById("videoPlayer").style.display = 'none';
            reinitialized = false;
        }

        function minimizeProfile() {
            document.getElementById('blackout').style.display = 'none';
            document.getElementById('profile').style.display = 'none';
            document.getElementById('mainFrame').className = 'main';
        }

        function maximizeProfile() {
            reinit();
            if (ITHASBEGUN) {
                ITHASBEGUN = false;
                close_doors(false);
            }
            document.getElementById('blackout').style.display = 'block';
            document.getElementById('mainFrame').className = 'main blurred';
			selectedUser = null;
            initProfile();
        }

		function getUserForProfile() {
			return selectedUser == null ? currentUser : selectedUser;
		}

		function initProfile() {
			loadAchievements();
			parseProfile();
		}

		function changeSelectedUser(newUser) {
			selectedUser = newUser;
			initGameAchievements();
			parseProfile();
			loadRating();
		}

		var firstRowInnerHTML = "";
		var secondRowInnerHTML = "";

        function loadAchievements() {
			var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getGameAchievements";
			suspend();
			Ext.Ajax.request({
				url: url,
				success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						firstRowInnerHTML = "";
						secondRowInnerHTML = "";
						var index = 0;
						for (var prop in a.achievements) {
							if (index < 16) {
								firstRowInnerHTML += '<div class="profileAchievement" id="profileAchievement' + a.achievements[prop].index + '"><div class="profileAchievementImage"></div><p class="profileAchievementValue">' + a.achievements[prop].name + '</p></div>';
							} else {
								secondRowInnerHTML += '<div class="profileAchievement" id="profileAchievement' + a.achievements[prop].index + '"><div class="profileAchievementImage"></div><p class="profileAchievementValue">' + a.achievements[prop].name + '</p></div>';
							}
							index++;
						}
						initGameAchievements();
						showGameAchievements();
						resume();
					} finally {
						resume();
					}
				},
				failure: function (response, opts) {
					resume();
				},
                jsonData: {
                    name: getUserForProfile()
                }
			});
        }

		function initGameAchievements() {
			var container = document.getElementById('profileAchievementsContent');
			container.children[0].innerHTML = firstRowInnerHTML;
			container.children[1].innerHTML = secondRowInnerHTML;
		}

        function loadRating() {
			var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getGameRating";
			suspend();
			Ext.Ajax.request({
				url: url,
				success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var container = document.getElementById('profileRatingContent');
						var index = 0;
						var string = '<div class="profileTablePane">';
						for (var prop in a.rating) {
							string += getUserForProfile() == a.rating[prop].name ? '<div class="profileTableCurrentRow">' : '<div class="profileTableRow">';
							string += '<p class="profileIndexText">' + (index + 1) + '</p>';
							string += '<p class="profileText"><a href="javascript:changeSelectedUser(' + "'" + a.rating[prop].name + "'" + ')">' + a.rating[prop].name + '</a></p>';
							string += '<p class="profileIndexText">' + a.rating[prop].exp + '</p>';
							string += '</div>';
							index++;
						}
						string += '</div>';
						container.innerHTML = string;
						showGameRating();
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
				},
				failure: function (response, opts) {
					resume();
				},
                jsonData: {
                    name: getUserForProfile()
                }
			});
        }

		var coursesString;
		var courseString;
		var themeString;
		var testString;
		var testRunString;

        function loadProgressCourses() {
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getCoursesProgress";
			suspend();
            Ext.Ajax.request({
                url: url,
                success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var navigation = document.getElementById('profileProgressNavigation');
						coursesString = '<a href="javascript:loadProgressCourses()">Курсы</a>';
						navigation.innerHTML = coursesString;
						var container = document.getElementById('profileProgressContent');
						var string = '<div><table>';
						for (i = 0; i < a.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText"><a href="javascript:loadProgressCourse(' + "'" + a[i].id + "'" + ')">' + a[i].name + '</a></p></td>';
							string += '<td class="progressColumn"><p class="profileIndexText">' + a[i].progress + '</p></td>';
							string += '</tr>';
						}
						string += '</table></div>';
						container.innerHTML = string;
						showGameProgress();
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
                },
                failure: function (response, opts) {
                    resume();
                },
                jsonData: {
                    name: getUserForProfile()
                }
            });
        }

        function loadProgressCourse(id) {
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getCourseProgress";
			suspend();
            Ext.Ajax.request({
                url: url,
                success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var navigation = document.getElementById('profileProgressNavigation');
						courseString = ' -> <a href="javascript:loadProgressCourse(' + "'" + id + "'" + ')">Курс</a>';
						navigation.innerHTML = coursesString + courseString;
						var container = document.getElementById('profileProgressContent');
						var string = '<div><table>';
						for (i = 0; i < a.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText"><a href="javascript:loadProgressTheme(' + "'" + a[i].id + "'" + ')">' + a[i].name + '</a></p></td>';
							string += '<td class="progressColumn"><p class="profileIndexText">' + a[i].progress + '</p></td>';
							string += '</tr>';
						}
						string += '</table></div>';
						container.innerHTML = string;
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
                },
                failure: function (response, opts) {
                    resume();
                },
                jsonData: {
                    name: getUserForProfile(),
                    courseId: id
                }
            });
        }

        function loadProgressTheme(id) {
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getThemeProgress";
			suspend();
            Ext.Ajax.request({
                url: url,
                success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var navigation = document.getElementById('profileProgressNavigation');
						themeString = ' -> <a href="javascript:loadProgressTheme(' + "'" + id + "'" + ')">Тема</a>';
						navigation.innerHTML = coursesString + courseString + themeString;
						var container = document.getElementById('profileProgressContent');
						var string = '<div><table>';
						string += '<tr><td colcount="2"><p style="margin-left: 30px;" class="profileText">Лекции</p></td></tr>';
						for (i = 0; i < a.lectures.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText">' + a.lectures[i].name + '</p></td>';
							string += '<td class="progressColumn"><p class="profileIndexText">' + a.lectures[i].progress + '</p></td>';
							string += '</tr>';
						}
						string += '<tr><td colcount="2"><p style="margin-left: 30px;" class="profileText">Тесты</p></td></tr>';
						for (i = 0; i < a.tests.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText"><a href="javascript:loadProgressTest(' + "'" + a.tests[i].id + "'" + ')">' + a.tests[i].name + '</a></p></td>';
							string += '<td class="progressColumn"><p class="profileIndexText">' + a.tests[i].progress + '</p></td>';
							string += '</tr>';
						}
						string += '</table></div>';
						container.innerHTML = string;
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
                },
                failure: function (response, opts) {
                    resume();
                },
                jsonData: {
                    name: getUserForProfile(),
                    themeId: id
                }
            });
        }

        function loadProgressTest(id) {
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getTestProgress";
			suspend();
            Ext.Ajax.request({
                url: url,
                success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var container = document.getElementById('profileProgressContent');
						var navigation = document.getElementById('profileProgressNavigation');
						testString = ' -> <a href="javascript:loadProgressTest(' + "'" + id + "'" + ')">Тест</a>';
						navigation.innerHTML = coursesString + courseString + themeString + testString;
						var string = '<div><table>';
						for (i = 0; i < a.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText"><a href="javascript:loadProgressTestRun(' + "'" + a[i].id + "'" + ')">' + a[i].date + '</a></p></td>';
							string += '<td class="progressColumn"><p class="profileIndexText">' + a[i].progress + '</p></td>';
							string += '</tr>';
						}
						string += '</table></div>';
						container.innerHTML = string;
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
                },
                failure: function (response, opts) {
                    resume();
                },
                jsonData: {
                    name: getUserForProfile(),
                    testId: id
                }
            });
        }

        function loadProgressTestRun(id) {
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getTestRunProgress";
			suspend();
            Ext.Ajax.request({
                url: url,
                success: function (response, opts) {
					try {
						var a = eval('(' + response.responseText + ')');
						if (a.success == false) {
							return;
						}
						var container = document.getElementById('profileProgressContent');
						var navigation = document.getElementById('profileProgressNavigation');
						testRunString = ' -> <a href="javascript:loadProgressTestRun(' + "'" + id + "'" + ')">Прохождение</a>';
						navigation.innerHTML = coursesString + courseString + themeString + testString + testRunString;
						var string = '<div><table>';
						for (i = 0; i < a.length; i++) {
							string += '<tr>';
							string += '<td><p class="profileText">' + a[i].text.substring(0, 28) + '...</p></td>';
							string += '</tr>';
						}
						string += '</table></div>';
						container.innerHTML = string;
						$('.profileTablePane').jScrollPane();
					} finally {
						resume();
					}
                },
                failure: function (response, opts) {
                    resume();
                },
                jsonData: {
                    name: getUserForProfile(),
                    testRunId: id
                }
            });
        }

        function parseProfile() {
			var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1) + "render/getProfile";
			suspend();
			Ext.Ajax.request({
				url: url,
				success: function (response, opts) {
					var a = eval('(' + response.responseText + ')');
					if (a.success == false) {
						document.getElementById('profile').style.display = 'block';
						return;
					}
					document.getElementById('profileName').innerHTML = a.model.Name;
					document.getElementById('profileEmail').innerHTML = a.model.Email;
					if (a.model.Money <= 9999) {
						document.getElementById('profileMoneyValue').innerHTML = a.model.Money;
					} else {
						document.getElementById('profileMoneyValue').innerHTML = '9999+';
					}
					document.getElementById('profileProgressValue').innerHTML = a.model.Progress + '%';
					document.getElementById('profileRatingValue').innerHTML = a.model.Rating + 1;
					if (a.model.Achievements.length == a.model.AchievementsCount) {
						document.getElementById('profileAchievements').className = 'profileAchievements profileAchievementsGold';
					} else {
						document.getElementById('profileAchievements').className = 'profileAchievements profileAchievementsBronze';
					}
					if (a.model.Progress == 100) {
						document.getElementById('profileProgress').className = 'profileProgress profileProgress100';
					} else if (a.model.Progress >= 75) {
						document.getElementById('profileProgress').className = 'profileProgress profileProgress75';
					} else if (a.model.Progress >= 50) {
						document.getElementById('profileProgress').className = 'profileProgress profileProgress50';
					} else if (a.model.Progress >= 25) {
						document.getElementById('profileProgress').className = 'profileProgress profileProgress25';
					} else {
						document.getElementById('profileProgress').className = 'profileProgress profileProgress0';
					}
					if (a.model.Rating < 5) {
						document.getElementById('profileRating').className = 'profileRating profileRatingGold';
					} else if (a.model.Rating < 10) {
						document.getElementById('profileRating').className = 'profileRating profileRatingSilver';
					} else {
						document.getElementById('profileRating').className = 'profileRating profileRatingBronze';
					}
					for (var prop in a.model.Achievements) {
						if (a.model.Achievements.hasOwnProperty(prop)) {
							if (prop <= 16) {
								document.getElementById("profileAchievement" + prop).children[0].style = "background: url(content/sprites/profile/achievement/" + a.model.Achievements[prop] + ")";
							} else {
								document.getElementById("profileAchievement" + prop).children[0].style = "background: url(content/sprites/profile/achievement/" + a.model.Achievements[prop] + ")";
							}
						}
					}
					document.getElementById('profile').style.display = 'block';
				},
				failure: function (response, opts) {
					document.getElementById('profile').style.display = 'block';
				},
				jsonData: {
					name: getUserForProfile()
				}
			});
        }

        function showGameAchievements() {
            document.getElementById('profileAchievementsTab').style.display = 'block';
            document.getElementById('profileRatingTab').style.display = 'none';
            document.getElementById('profileProgressTab').style.display = 'none';
        }

        function showGameRating() {
            document.getElementById('profileAchievementsTab').style.display = 'none';
            document.getElementById('profileRatingTab').style.display = 'block';
            document.getElementById('profileProgressTab').style.display = 'none';
        }

        function showGameProgress() {
            document.getElementById('profileAchievementsTab').style.display = 'none';
            document.getElementById('profileRatingTab').style.display = 'none';
            document.getElementById('profileProgressTab').style.display = 'block';
        }
    </script>
}
@section topPanel{

    <div class="toppanel">
        <div class="toppanelleft">
            <a href="javascript:main_page()">
                <img id="buttonMain" src="/Content/Sprites/button_main_a.png">
                <p align="center" style="position:absolute;top:-6px;left:13px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Главная</p>
            </a>
        </div>
        <div class="toppanelcenter">
            <a href="javascript:about()">
                <img id="buttonAbout" src="/Content/Sprites/button_about_ia.png">
                <p align="center" style="position:absolute;top:-6px;left:5px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">О проекте</p>
            </a>
        </div>
        <div class="toppanelright">
            <a href="javascript:contacts()">
                <img id="buttonContacts" src="/Content/Sprites/button_contact_ia.png">
                <p align="center" style="position:absolute;top:-6px;left:9px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Контакты</p>
            </a>
        </div>
    </div>
}

@section renderArea{

    <div class="unityarea">
        <img id="updater" src="/Content/Sprites/black_back.png" class="updater">
        <div class="loading" id="loadingContainer" style="overflow:visible">
            <img src="/Content/Sprites/loading/loading.png" class="loadingRing">
            <img src="/Content/Sprites/loading/indicator.png" class="loadingIndicator">
            <p align="center" id="awaitingAuthorisation" style="position: absolute; top: 50px; display: block; font-size: 20px; color: #eeeeee; letter-spacing: 0.8px; line-height: 30px; font-family: Futurica; ">Ожидается авторизация пользователя</p>
            <p align="center" id="awaitingLoading" style="position: absolute; top: 80px; left: 65px; display: none; font-size: 20px; color: #eeeeee; letter-spacing: 0.8px; line-height: 30px; font-family: Futurica">Загрузка</p>
            <div id="error" style="display:none">
                <p align="center" style="cursor: pointer;position:absolute;top:60px;left:70px;font-size: 20px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica" onclick="javascript:openAuthWindow()">Ошибка</p>
                <p align="center" style="cursor: pointer;position:absolute;top:100px;left:40px;font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica" onclick="javascript:openAuthWindow()">попробуйте еще раз</p>
                <img src="/Content/Sprites/refresh.png" style="cursor: pointer; position:absolute; top: 145px; left: 102px;" onclick="javascript:openAuthWindow()">
            </div>
        </div>
        <div id="unityPlayer" style="width: 809px; height: 400px; position: static">
        </div>
        <div id="videoPlayer" style="width: 809px; height: 400px; position: static">
        </div>
        <div class="dots" id="dotsContainer">
            <img src="/Content/Sprites/dots/dots_1.png" style="display:block">
            <img src="/Content/Sprites/dots/dots_2.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_3.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_4.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_5.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_6.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_7.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_8.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_9.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_10.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_11.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_12.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_13.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_14.png" style="display:none">
            <img src="/Content/Sprites/dots/dots_15.png" style="display:none">
        </div>
        <div id="contactsContainer" style="width: 809px; height: 400px; position: static; display:none">
            <img src="/Content/Sprites/contacts_back.png" style="display:block; position:absolute;top:0px;left:0px;">
            <img id="pointer" class="pointer" src="/Content/Sprites/contacts_pointer.jpg">
            <img src="/Content/Sprites/logo.png" class="logo">

            <div class="headerareaContacts">
                <p style="font-size: 24px;color: #eeeeee;letter-spacing:0.8px;line-height:10px;font-family: Futurica">Школа информатики СГАУ</p>
                <p style="font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:10px;font-family: Futurica">Кафедра программных систем</p>
            </div>
            <div class="textareaContacts">
                <p align="center" style="font-size: 15px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica">
                    ул. Гая, д. 43
                    <br>
                    ком. 515 (14 корпус)
                    <br>
                    телефон 8(846) 267-46-73
                </p>
            </div>
            <p align="center" style="position:absolute;top:121px;left:520px;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica">
                ул. Гая
            </p>
            <p align="center" style="position:absolute;top:153px;left:468px;font-size: 15px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica">
                43
            </p>
            <p align="center" style="position:absolute;top:270px;left:315px;-webkit-transform: rotate(270deg);-moz-transform: rotate(270deg);-ms-transform: rotate(270deg);-o-transform: rotate(270deg);transform: rotate(270deg);font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica">
                ул. Лукачева
            </p>
        </div>
        <div id="aboutContainer">
            <img id="back" src="/Content/Sprites/back.png" style="display:block; position:absolute;top:0px;left:0px;">
            <img id="backScreens" src="/Content/Sprites/back_screens.png" style="display:none; position:absolute;top:0px;left:0px;">
            <img src="/Content/Sprites/logo.png" class="logo">
            <div class="textareaAbout">
                <br>
                <div id="headers" class="headersAbout">
                    <a href="javascript:selectAuthors()"><img src="/Content/Sprites/about/authorsSel.png" id="authorsButton"></a>
                    <a href="javascript:selectScreens()"><img src="/Content/Sprites/about/screens.png" id="screensButton"></a>
                    <a href="javascript:selectAwards()"><img src="/Content/Sprites/about/awards.png" id="awardsButton"></a>
                    <a href="javascript:selectAchievements()"><img src="/Content/Sprites/about/achievements.png" id="achievementsButton"></a>
                </div>
                <br>
                <div id="authorsContainer" style="display:block">
                    <div class="slider_authors" id="slider_authors">
                        <div class="slider_authors_frame"></div>
                        <div class="slider_authors_content" id="sliderAuthorsContainer"></div>
                    </div>
                    <div class="arrows_container" id="authorsArrowsContainer">
                        <div class="arrow" style="background: url(content/sprites/arrow_left_ia.png) no-repeat;" onclick="javascript:sliderAuthorsDecr()"></div>
                        <div id="authorsPointContainer">
                        </div>
                        <div class="arrow" style="background: url(content/sprites/arrow_right_ia.png) no-repeat;" onclick="javascript:sliderAuthorsIncr()"></div>
                        <p id="authorsNumber" style="position:absolute; margin-top: 5px; margin-left: 320px; display:block;font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica"></p>
                    </div>
                    <div id="textAuthorsContainer">
                    </div>
                </div>
                <div id="screensContainer" style="display:none">
                    <div class="slider_screen_content" id="sliderScreensContainer">

                    </div>
                    <div class="arrows_container" id="screensArrowsContainer" style="display:none">
                        <div class="arrow" style="background: url(content/sprites/arrow_left_ia.png) no-repeat;" onclick="javascript:sliderScreensDecr()"></div>
                        <div id="screensPointContainer">
                        </div>
                        <div class="arrow" style="background: url(content/sprites/arrow_right_ia.png) no-repeat;" onclick="javascript:sliderScreensIncr()"></div>
                    </div>
                    <div class="big_arrow_left" onclick="javascript:sliderScreensDecr()" style="cursor: pointer;"></div>
                    <div class="big_arrow_right" onclick="javascript:sliderScreensIncr()" style="cursor: pointer;"></div>
                </div>
                <div id="awardsContainer" style="display:none">
                    <div class="slider_awards" id="slider_awards">
                        <div class="slider_awards_frame"></div>
                        <div class="slider_awards_left" onclick="javascript:sliderAwardsImgDecr()"></div>
                        <div class="slider_awards_right" onclick="javascript:sliderAwardsImgIncr()"></div>
                        <div class="slider_awards_content" id="sliderAwardsContainer">
                        </div>
                    </div>
                    <div class="arrows_container" id="awardsArrowsContainer">
                        <div class="arrow" style="background: url(content/sprites/arrow_left_ia.png) no-repeat;" onclick="javascript:sliderAwardsDecr()"></div>
                        <div id="awardsPointContainer"></div>
                        <div class="arrow" style="background: url(content/sprites/arrow_right_ia.png) no-repeat;" onclick="javascript:sliderAwardsIncr()"></div>
                        <p id="awardsNumber" style="position:absolute; margin-top: 5px; margin-left: 320px; display:block;font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica"></p>
                    </div>
                    <div id="textAwardsContainer">
                    </div>
                </div>
                <div id="achievementsContainer" style="display:none">
                    <div class="slider_awards" id="slider_achievements">
                        <div class="slider_awards_frame"></div>
                        <div class="slider_awards_left" onclick="javascript:sliderAchievementsImgDecr()"></div>
                        <div class="slider_awards_right" onclick="javascript:sliderAchievementsImgIncr()"></div>
                        <div class="slider_awards_content" id="sliderAchievementsContainer">
                        </div>
                    </div>
                    <div class="arrows_container" id="achievementsArrowsContainer">
                        <div class="arrow" style="background: url(content/sprites/arrow_left_ia.png) no-repeat;" onclick="javascript:sliderAchievementsDecr()"></div>
                        <div id="achievementsPointContainer"></div>
                        <div class="arrow" style="background: url(content/sprites/arrow_right_ia.png) no-repeat;" onclick="javascript:sliderAchievementsIncr()"></div>
                        <p id="achievementsNumber" style="position:absolute; margin-top: 5px; margin-left: 320px; display:block;font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica"></p>
                    </div>
                    <div id="textAchievementsContainer">
                    </div>
                </div>
            </div>
            <div id="screenshots" style="position:absolute;background: #000000;width:809px;height:400px;display:none;overflow:hidden;cursor: pointer; margin-left:-404px;top:10px;left:50%">

                <div class="screens_left" onclick="javascript:screensDecr()" style="cursor:ponter;"></div>
                <div class="screens_right" onclick="javascript:screensIncr()" style="cursor:ponter;"></div>
            </div>
        </div>

    </div>
    <div class="renderarea" id="mainDoors">
        <div class="doorleft" id="doorl">
            <img src="/Content/Sprites/door_left.jpg">
        </div>
        <div class="doorright" id="doorr">
            <img src="/Content/Sprites/door_right.jpg">
        </div>
        <div class="enter" id="container">
            <img src="/Content/Sprites//enter//enter1.png" id="enter1" style="display: none">
            <img src="/Content/Sprites//enter//enter2.png" id="enter2" style="display: none">
            <img src="/Content/Sprites//enter//enter3.png" id="enter3" style="display: none">
            <img src="/Content/Sprites//enter//enter4.png" id="enter4" style="display: none">
            <img src="/Content/Sprites//enter//enter5.png" id="enter5" style="display: none">
            <img src="/Content/Sprites//enter//enter6.png" id="enter6" style="display: none">
            <img src="/Content/Sprites//enter//enter7.png" id="enter7" style="display: none">
            <img src="/Content/Sprites//enter//enter8.png" id="enter8" style="display: none">
            <img src="/Content/Sprites//enter//enter9.png" id="enter9" style="display: none">
            <img src="/Content/Sprites//enter//enter10.png" id="enter10" style="display: none">
            <img src="/Content/Sprites//enter//enter11.png" id="enter11" style="display: none">
            <img src="/Content/Sprites//enter//enter12.png" id="enter12" style="display: none">
            <img src="/Content/Sprites//enter//enter13.png" id="enter13" style="display: none">
            <canvas id="rotate"></canvas>
        </div>
        <div class="enter" id="container" onclick="javascript:enter_main()" onmouseover=" javascript: enter_animate()"
             onmouseout="javascript:enter_stop()" style="cursor: pointer;">
        </div>
        <div class="renderOverlayT">
        </div>
        <div class="renderOverlayL">
        </div>
        <div class="renderOverlayR">
        </div>
        <div class="renderOverlayB">
        </div>
    </div>

}
@section end {
    <div id="blackout" style="background: #000000;opacity:0.8;display:none;width:100%;height:100%;position:absolute">
    </div>
    <img id="fullsize" align="middle" style="position:absolute;display:none;cursor: pointer;max-width: 1300px; max-height:700px;" onclick="javascript:hideImage()">
    <div id="profile" style="display:none;width:100%;height:100%;position:absolute">
        <div id="profileFrame" class="profileFrame">
            <div id="profileBackLeft" class="profileBackLeft">
            </div>
            <div id="profileBackRight" class="profileBackRight">
            </div>
            <div id="profileHeader" class="profileHeader">
                <div id="profileInfo" class="profileInfo">
                    <div id="profileAvatar" class="profileAvatar">
                    </div>
                    <p id="profileName" class="profileName"></p>
                    <p id="profileEmail" class="profileEmail"></p>
                    <div id="profileMoney" class="profileMoney">
                        <p id="profileMoneyValue" class="profileMoneyValue"></p>
                    </div>
                </div>
                <div id="profileProgress" class="profileProgress" onclick="javascript:loadProgressCourses()">
                    <p id="profileProgressValue" class="profileProgressValue"></p>
                </div>
                <div id="profileRating" class="profileRating" onclick="javascript:loadRating()">
                    <p id="profileRatingValue" class="profileRatingValue"></p>
                </div>
                <div id="profileAchievements" class="profileAchievements" onclick="javascript:showGameAchievements()">
                </div>
                <div id="profileMinimize" class="profileMinimize" onclick="javascript:minimizeProfile()">
                </div>
            </div>
            <div id="profileSeparator" class="profileSeparator">
            </div>
            <div id="profileContent" class="profileContent">
                <div id="profileAchievementsTab">
                    <div id="profileAchievementsContent" class="profileAchievementsContent">
                        <div class="profileAchievementsRows">
                        </div>
                        <div class="profileAchievementsShortRow">
                        </div>
                    </div>
                </div>
                <div id="profileRatingTab">
                    <div id="profileRatingContent" class="profileRatingContent">

                    </div>
                </div>
                <div id="profileProgressTab">
                    <div class="profileProgressNavigation"><p id="profileProgressNavigation" style="text-align:left" class="profileText"></p></div>
                    <div id="profileProgressContent" class="profileProgressContent">

                    </div>
                </div>
                <div id="profileSlider" class="profileSlider">
                </div>
            </div>

        </div>
    </div>
}

